#cloud-config

package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - htop
  - docker.io

write_files:
  - path: /etc/clawdbot/config.json
    permissions: "0600"
    content: |
      {
        "gateway": {
          "bind": "loopback",
          "port": 18789,
          "auth": {
            "mode": "token"
          },
          "controlUi": {
            "enabled": true
          }
        },
        "agents": {
          "defaults": {
            "provider": "anthropic",
            "model": "claude-3-5-sonnet-20241022",
            "sandbox": {
              "mode": "non-main"
            }
          }
        },
        "pairing": {
          "defaults": {
            "mode": "approval-required"
          }
        }
      }

  - path: /etc/environment
    append: true
    content: |
      ANTHROPIC_API_KEY="${anthropic_api_key}"
      CLAWDBOT_GATEWAY_TOKEN="${gateway_token}"
      TWINGATE_ACCESS_TOKEN="${twingate_access_token}"
      TWINGATE_REFRESH_TOKEN="${twingate_refresh_token}"
      TWINGATE_NETWORK="${twingate_network}"

runcmd:
  # Install Node.js 22
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs

  # Install Moltbot/Clawdbot
  - curl -fsSL https://molt.bot/install.sh | bash

  # Install Twingate Connector
  - |
    curl "https://binaries.twingate.com/connector/setup.sh" | \
    TWINGATE_ACCESS_TOKEN="${twingate_access_token}" \
    TWINGATE_REFRESH_TOKEN="${twingate_refresh_token}" \
    TWINGATE_NETWORK="${twingate_network}" \
    TWINGATE_LABEL_DEPLOYED_BY="clawdbot-auto" \
    bash

  # Configure and start Moltbot
  - mkdir -p ~/.clawdbot
  - source /etc/environment
  - moltbot onboard --install-daemon --non-interactive || true
  - systemctl enable moltbot-gateway
  - systemctl start moltbot-gateway

  # Verify services
  - systemctl status twingate-connector
  - systemctl status moltbot-gateway

  - echo "Twingate Connector and Clawdbot Gateway deployed"

final_message: "Both services ready after $UPTIME seconds"
