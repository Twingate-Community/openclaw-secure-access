#cloud-config

package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - htop
  - docker.io

write_files:
  - path: /etc/environment
    append: true
    content: |
      TWINGATE_ACCESS_TOKEN="${twingate_access_token}"
      TWINGATE_REFRESH_TOKEN="${twingate_refresh_token}"
      TWINGATE_NETWORK="${twingate_network}"

runcmd:
  # Note: Moltbot is pre-installed from marketplace image
  # Only need to configure Twingate and environment

  # Update or add gateway token to clawdbot.env (overwrite existing entry)
  - |
    touch /opt/clawdbot.env
    sed -i '/^CLAWDBOT_GATEWAY_TOKEN=/d' /opt/clawdbot.env
    echo "CLAWDBOT_GATEWAY_TOKEN=${gateway_token}" >> /opt/clawdbot.env
    chmod 0600 /opt/clawdbot.env

  # Configure Caddy to only listen on private IP (no public access)
  - |
    PRIVATE_IP=$(ip -4 addr show eth1 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
    cat > /etc/caddy/Caddyfile <<EOF
    $${PRIVATE_IP} {
        reverse_proxy localhost:18789
        header X-DO-MARKETPLACE "moltbot"
    }
    EOF
  - systemctl restart caddy
  # Install Twingate Connector
  - |
    curl "https://binaries.twingate.com/connector/setup.sh" | \
    TWINGATE_ACCESS_TOKEN="${twingate_access_token}" \
    TWINGATE_REFRESH_TOKEN="${twingate_refresh_token}" \
    TWINGATE_NETWORK="${twingate_network}" \
    TWINGATE_LABEL_DEPLOYED_BY="community-moltbot-DO" \
    bash

  # Restart gateway to pick up env file changes
  - systemctl restart clawdbot

  # Verify services
  - systemctl status twingate-connector
  - systemctl status clawdbot

  - echo "Twingate Connector and Moltbot Gateway deployed"

final_message: "Both services ready after $UPTIME seconds"
