#cloud-config

package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - htop
  - docker.io

write_files:
  - path: /etc/environment
    append: true
    content: |
      TWINGATE_ACCESS_TOKEN="${twingate_access_token}"
      TWINGATE_REFRESH_TOKEN="${twingate_refresh_token}"
      TWINGATE_NETWORK="${twingate_network}"

runcmd:
  # Note: OpenClaw is pre-installed from marketplace image
  # Only need to configure Twingate and environment

  # Update or add gateway token to openclaw.env (overwrite existing entry)
  - |
    touch /opt/openclaw.env
    sed -i '/^OPENCLAW_GATEWAY_TOKEN=/d' /opt/openclaw.env
    echo "OPENCLAW_GATEWAY_TOKEN=${gateway_token}" >> /opt/openclaw.env
    chmod 0600 /opt/openclaw.env

  # Configure Caddy to only listen on private IP (no public access)
  - |
    PRIVATE_IP=$(ip -4 addr show eth1 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
    cat > /etc/caddy/Caddyfile <<EOF
    $${PRIVATE_IP} {
        reverse_proxy localhost:18789
        header X-DO-MARKETPLACE "openclaw"
    }
    EOF
  - systemctl restart caddy
  # Install Twingate Connector
  - |
    curl "https://binaries.twingate.com/connector/setup.sh" | \
    TWINGATE_ACCESS_TOKEN="${twingate_access_token}" \
    TWINGATE_REFRESH_TOKEN="${twingate_refresh_token}" \
    TWINGATE_NETWORK="${twingate_network}" \
    TWINGATE_LABEL_DEPLOYED_BY="community-openclaw-DO" \
    bash

  # Restart gateway to pick up env file changes
  - systemctl restart openclaw

  # Verify services
  - systemctl status twingate-connector
  - systemctl status openclaw

  - echo "Twingate Connector and OpenClaw Gateway deployed"

final_message: "Both services ready after $UPTIME seconds"
